use v6.d;
use Test;
use Text::Homoglyph::ASCII;

plan 46;

# Test 1: Basic ASCII detection - no homoglyphs
{
    my $text = 'Hello World 123';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Hello World 123', 'Clean ASCII text remains unchanged';
}

# Test 2: Cyrillic homoglyphs
{
    my $text = 'ĞĞµllo WĞ¾rld';  # H and o are Cyrillic
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Hello World', 'Cyrillic homoglyphs converted to ASCII';
}

# Test 3: Greek homoglyphs
{
    my $text = 'Î‘lpha Î’eta';  # A and B are Greek
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Alpha Beta', 'Greek homoglyphs converted to ASCII';
}

# Test 4: Mathematical alphanumeric symbols
{
    my $text = 'ğ‡ğğ¥ğ¥ğ¨ ğŸğŸğŸ‘';  # Bold mathematical
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Hello 123', 'Mathematical bold converted to ASCII';
}

# Test 5: Fullwidth forms
{
    my $text = 'ï¼¨ï½…ï½Œï½Œï½ã€€ï¼·ï½ï½’ï½Œï½„';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Hello World', 'Fullwidth forms converted to ASCII';
}

# Test 6: Mixed homoglyphs
{
    my $text = 'ï¼¨Ğµlâ„“o á”Î¿rld';  # Mix of fullwidth, Cyrillic, script, Cherokee, Greek
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Hello World', 'Mixed homoglyphs converted to ASCII';
}

# Test 7: Numbers
{
    my $text = 'ğŸğŸğŸ‘ + ï¼”ï¼•ï¼– = 789';
    my $cleaned = clean-ascii($text);
    is $cleaned, '123 + 456 = 789', 'Various number forms converted to ASCII';
}

# Test 8: Multi-character replacements
{
    my $text = 'ï¬le ï¬€ Ä³';  # fi ligature, ff ligature, ij ligature
    my $cleaned = clean-ascii($text);
    is $cleaned, 'file ff ij', 'Ligatures converted to ASCII sequences';
}

# Test 9: Empty string
{
    my $text = '';
    my $cleaned = clean-ascii($text);
    is $cleaned, '', 'Empty string remains empty';
}

# Test 10: Spaces and punctuation
{
    my $text = '   Hello, World!   ';
    my $cleaned = clean-ascii($text);
    is $cleaned, '   Hello, World!   ', 'Spaces and punctuation preserved';
}

# Test 11: Detection function - no homoglyphs
{
    my $text = 'Hello World';
    my @detected = detect-ascii-homoglyphs($text);
    is @detected.elems, 0, 'No homoglyphs detected in clean ASCII';
}

# Test 12: Detection function - single homoglyph
{
    my $text = 'Ğello';  # Cyrillic H
    my @detected = detect-ascii-homoglyphs($text);
    is @detected.elems, 1, 'Single homoglyph detected';
    is @detected[0]<char>, 'Ğ', 'Correct homoglyph character identified';
    is @detected[0]<ascii>, 'H', 'Correct ASCII replacement identified';
    is @detected[0]<position>, 0, 'Correct position identified';
}

# Test 13: Detection function - multiple homoglyphs
{
    my $text = 'ĞĞµllo WĞ¾rld';  # Cyrillic H, e, and o
    my @detected = detect-ascii-homoglyphs($text);
    is @detected.elems, 3, 'Multiple homoglyphs detected';
    is @detected[0]<position>, 0, 'First homoglyph at position 0';
    is @detected[2]<position>, 7, 'Third homoglyph at position 7';
}

# Test 14: Verbose function
{
    my $text = 'ĞĞµllo';
    my %result = clean-ascii-verbose($text);
    is %result<original>, 'ĞĞµllo', 'Original text preserved in verbose output';
    is %result<cleaned>, 'Hello', 'Cleaned text correct in verbose output';
    is %result<changed>, True, 'Changed flag is True when homoglyphs found';
    is %result<replacements>.elems, 2, 'Replacement count correct';
}

# Test 15: Verbose function - no changes
{
    my $text = 'Hello';
    my %result = clean-ascii-verbose($text);
    is %result<changed>, False, 'Changed flag is False when no homoglyphs';
}

# Test 16: Roman numerals
{
    my $text = 'Chapter â…¢: Section â…©â…¡';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Chapter III: Section XII', 'Roman numerals converted to ASCII';
}

# Test 17: Cherokee letters
{
    my $text = 'áªáŸá¾á”';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'AC0W', 'Cherokee letters converted to ASCII';
}

# Test 18: Script mathematical alphanumeric
{
    my $text = 'ğ’œâ„¬ğ’ = ğ’¶ğ’·ğ’¸';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'ABC = abc', 'Script mathematical converted to ASCII';
}

# Test 19: Sans-serif variants
{
    my $text = 'ğ–ºğ–»ğ–¼ ğŸ£ğŸ¤ğŸ¥';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'abc 123', 'Sans-serif variants converted to ASCII';
}

# Test 20: Ballot X marks
{
    my $text = 'Wrong âœ— Right âœ“';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'Wrong X Right âœ“', 'Ballot X converted, checkmark preserved';
}

# Test 21: Deseret alphabet
{
    my $text = 'ğ€ğšğ•';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'aBC', 'Deseret alphabet converted to ASCII';
}

# Test 22: Multi-character homoglyph detection
{
    my $text = 'ï¬le';  # fi ligature
    my @detected = detect-ascii-homoglyphs($text);
    is @detected.elems, 1, 'Ligature detected as single homoglyph';
    is @detected[0]<ascii>, 'fi', 'Ligature maps to correct ASCII sequence';
    is @detected[0]<length>, 1, 'Ligature length is 1 character';
}

# Test 23: Complex multi-language text
{
    my $text = 'ï¼´he Ô›uÑ–ck brÎ¿wn fÎ¿x jumps Î¿ver the lazy dÎ¿g';
    my $cleaned = clean-ascii($text);
    my $expected = 'The quick brown fox jumps over the lazy dog';
    is $cleaned, $expected, 'Complex multi-language homoglyphs cleaned';
}

# Test 24: Stress test with many homoglyphs
{
    my $text = 'ğ€ğğ‚ğƒğ„ğ…ğ†ğ‡ğˆğ‰ğŠğ‹ğŒğğğğğ‘ğ’ğ“ğ”ğ•ğ–ğ—ğ˜ğ™';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'Full alphabet of bold mathematical converted';
}

# Test 25: Performance with no homoglyphs (should be fast)
{
    my $text = 'a' x 1000;
    my $cleaned = clean-ascii($text);
    is $cleaned, $text, 'Large ASCII-only text processed correctly';
}

# Test 26: clean-ascii-more with accented characters
{
    my $text = 'cafÃ© naÃ¯ve rÃ©sumÃ©';
    my $cleaned = clean-ascii-more($text);
    is $cleaned, 'cafe naive resume', 'Accented characters decomposed and cleaned';
}

# Test 27: clean-ascii-more with homoglyphs and accents
{
    my $text = 'ĞĞµllo cafÃ©';  # Cyrillic H + accented e
    my $cleaned = clean-ascii-more($text);
    is $cleaned, 'Hello cafe', 'Homoglyphs replaced and accents removed';
}

# Test 28: clean-ascii-more with combining diacritics
{
    my $text = 'e' ~ "\x[0301]" ~ ' test';  # e + combining acute accent
    my $cleaned = clean-ascii-more($text);
    is $cleaned, 'e test', 'Combining diacritics removed';
}

# Test 29: clean-ascii-more preserves ASCII
{
    my $text = 'Hello World 123!@#$%^&*()_+-=[]{}|;:"<>,.?/~`';
    my $cleaned = clean-ascii-more($text);
    is $cleaned, $text, 'All ASCII characters preserved';
}

# Test 30: clean-ascii-more with emoji and non-ASCII
{
    my $text = 'Hello ğŸ‘‹ cafÃ© Ã±';
    my $cleaned = clean-ascii-more($text);
    is $cleaned, 'Hello ğŸ‘‹ cafe n', 'Emoji preserved, accents removed';
}

# Test 31: clean-ascii-pure basic test
{
    my $text = 'Hello World';
    my $cleaned = clean-ascii-pure($text);
    is $cleaned, 'Hello World', 'Pure ASCII text unchanged by clean-ascii-pure';
}

# Test 32: clean-ascii-pure with emoji
{
    my $text = 'Hello ğŸ‘‹ World';
    my $cleaned = clean-ascii-pure($text);
    is $cleaned, 'Hello _ World', 'Emoji replaced with underscore';
}

# Test 33: clean-ascii-pure with accents and emoji
{
    my $text = 'cafÃ© Ã±iÃ±o ğŸ‘';
    my $cleaned = clean-ascii-pure($text);
    is $cleaned, 'cafe nino _', 'Accents removed, emoji replaced with underscore';
}

# Test 34: clean-ascii-pure with homoglyphs, accents, and emoji
{
    my $text = 'ï¼¨Ã©llo cafÃ© ğŸ‘‹ WÃ¶rld';
    my $cleaned = clean-ascii-pure($text);
    is $cleaned, 'Hello cafe _ World', 'Complete cleaning to pure ASCII';
}

# Test 35: clean-ascii-pure with various non-ASCII
{
    my $text = 'Testâ„¢ â‚¬100 â†’nextâ† ä¸­æ–‡';
    my $cleaned = clean-ascii-pure($text);
    is $cleaned, 'TestTM _100 _next_ __', 'All non-ASCII replaced with underscores';
}

# Test 46: Additional Cyrillic mappings
{
    my $text = 'Ñ˜Ğˆ Ñ—Ğ‡ Ğ±6 Ğ—3 Ñ–I';
    my $cleaned = clean-ascii($text);
    is $cleaned, 'jJ iI b6 33 iI', 'Additional Cyrillic characters converted correctly';
}

done-testing;